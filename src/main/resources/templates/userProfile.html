<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        body {


            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #c2f382;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;

        }
        h1 {
            text-align: center;
        }
        .profile-info {
            margin-bottom: 20px;

        }
        .profile-info label {
            font-weight: bold;
        }
        .profile-info p {
            margin: 5px 0;
        }
        .change-email-form, .change-password-form {
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 10px;
        }
        .form-group label {
            display: block;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group button {
            padding: 8px 12px;
            background-color: #06a94d;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .delete-account {
            margin-top: 20px;
            text-align: center;
        }
        .delete-account button {
            padding: 8px 20px;
            background-color: #dc3545;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-body">

        <div class="row gutters-sm">
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body" style="background-color: #def8cd;">
                        <div class="d-flex flex-column align-items-center text-center">
                            <img src="https://bootdey.com/img/Content/avatar/avatar7.png" id="profilePic" alt="Admin" class="rounded-circle" width="150">
                            <label for="fileInputBtn" style="background-color:#06a94d;" class="btn btn-primary">Change photo</label>
                            <input type="file" accept="image/png, image/gif, image/jpeg" style="display: none" id="fileInputBtn"/>
                            <div class="mt-3">
                                <h4 id="fullName"></h4>
<!--                                <p class="text-secondary mb-1">Full Stack Developer</p>-->
                                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteProfileModal">Delete account</button>
<!--                                <button class="btn btn-outline-primary">Message</button>-->
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-body"  style="background-color: #def8cd;">
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0">Full Name</h6>
                            </div>
                            <div class="col-sm-9 text-secondary">
                                <span id="firstName"></span>
                                <span id="lastName"></span>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0">Email</h6>
                            </div>
                            <div class="col-sm-9 text-secondary">
                                <span id="email"></span>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0">Sessions</h6>
                            </div>
                            <div class="col-sm-9 text-secondary">
                                <span id="activeSessions"></span>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0">Phone</h6>
                            </div>
                            <div class="col-sm-9 text-secondary">
                                <span id="phoneNumber"></span>
                                <div class="mt-2">
                                    <input type="text" class="form-control" id="newPhoneNumber" placeholder="Enter new phone number">
                                    <button  style="background-color:#06a94d;" class="btn btn-primary mt-2" onclick="changePhoneNumber()">Change Phone Number</button>
                                </div>
                            </div>
                        </div>
                        <hr>

                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0">Address</h6>
                            </div>
                            <div class="col-sm-9 text-secondary">
                                <span id="address"></span>
                                <input type="text" class="form-control" id="country" placeholder="Country">
                                <input type="text" class="form-control mt-2" id="city" placeholder="City">
                                <input type="text" class="form-control mt-2" id="street" placeholder="Street">
                                <input type="text" class="form-control mt-2" id="building" placeholder="Building">
                                <input type="text" class="form-control mt-2" id="postalCode" placeholder="Postal Code">
                                <button  style="background-color:#06a94d;"class="btn btn-primary mt-2" onclick="changeAddress()">Change Address</button>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-sm-12">
                                <div  style="background-color:#06a94d; color: white" class="btn btn-info " data-bs-toggle="modal" data-bs-target="#changePasswordModal">Change password</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                <div  style="background-color:#06a94d; color: white" class="btn btn-info " data-bs-toggle="modal" data-bs-target="#activeSessions">Active sessions</div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Change password</h1>
                <button type="button" id="closeChangePasswordModal" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                    <div class="mb-3">
                        <label for="oldPasswordInput" class="form-label">Old password</label>
                        <input type="password" class="form-control" id="oldPasswordInput">
                    </div>
                    <div class="mb-3">
                        <label class="form-check-label" for="newPasswordInput">New password</label>
                        <input type="password" class="form-control" id="newPasswordInput">
                    </div>
                    <button type="submit" id="changePasswordBtn" class="btn btn-success">Submit</button>
            </div>
            <span style="display: none" id="successMessage">Password has changed successfully</span>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteProfileModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel1">Do you want to delete account?</h1>
                <button type="button" id="closeChangePasswordModal1" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are u sure?
                <div style="display: flex; justify-content: center; align-items: center; gap: 15px">
                        <button class="btn btn-danger" id="deleteAccountBtn">Yes</button>
                        <button class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                </div>
            </div>
            <!--            <div class="modal-footer">-->
            <!--                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>-->
            <!--                <button type="button" class="btn btn-primary">Save changes</button>-->
            <!--            </div>-->
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script>
    /*function getUserProfile() {
        // Use your API endpoint to get user profile data
        // Update the HTML elements with the retrieved data
        // Example:
        document.getElementById('username').innerText = 'JohnDoe';
        document.getElementById('firstName').innerText = 'John';
        document.getElementById('phoneNumber').innerText = '1234567890';
        document.getElementById('address').innerText = '123 Main St, City';
        document.getElementById('email').innerText = 'john@example.com';
        document.getElementById('profilePicture').src = 'https://via.placeholder.com/100';
    }*/
    function getUserProfile() {
        const token = localStorage.getItem("jwtToken")
        fetch('http://localhost:8080/users/getProfile', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
                // You may need to include additional headers like Authorization token if required by your backend
            }
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401)
                    {
                        location.href = 'registration.html'
                    }
                    throw new Error('Failed to fetch user profile');
                }
                return response.json();
            })
            .then(data => {
                // Update the HTML elements with the retrieved user profile data
                // console.log(document.getElementById('firstName'))
                let fullName = data.firstName + ' ' + data.lastName;
                console.log(data)

                document.getElementById('fullName').innerText = fullName;
                document.getElementById('email').innerText = data.email;
                document.getElementById('firstName').innerText = data.firstName;
                document.getElementById('lastName').innerText = data.lastName;

                document.getElementById('profilePic').src = data.photo;
                document.getElementById('phoneNumber').innerText = data.phoneNumber ? data.phoneNumber : 'not set';
                document.getElementById('address').innerText = data.address === "null" ? "not set" : data.address;

                // Populate active sessions
                var browsersText = '';
                data.activeSessions.forEach(function(session, index) {
                    let id = data.activeSessions[index].sessionid
                    browsersText += session.browser + ` <button class="btn btn-danger"  onclick="deleteSession('${id}')">Delete</button><br>`;
                });
                document.getElementById('activeSessions').innerHTML   = browsersText;

            })
            .catch(error => {
                console.error('Error fetching user profile:', error);
            });
    }

    document.getElementById("changePasswordBtn").addEventListener("click", changePassword)
    document.getElementById("deleteAccountBtn").addEventListener("click", deleteAccount)
    document.getElementById("fileInputBtn").addEventListener("change", uploadProfilePicture)

    function deleteSession(sessionId) {
        const token = localStorage.getItem("jwtToken");
        console.log("SID", sessionId)
        fetch('http://localhost:8080/users/delete-session?sessionId=' + sessionId, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete session');
                }
                // Refresh the user profile after deleting session
                getUserProfile();
            })
            .catch(error => {
                console.error('Error deleting session:', error);
                console.error(sessionId);
                // Optionally, provide feedback to the user that an error occurred
            });
    }
    function uploadProfilePicture() {
        // Implement logic to upload profile picture using your API endpoint
        // Retrieve file from input field and make API call
        // Example:
        let file = document.getElementById('fileInputBtn').files[0];
        let data = new FormData()
        data.append('file', file)
        const token = localStorage.getItem("jwtToken")
        fetch('http://localhost:8080/users/uploadPhoto', {
            method: 'PATCH',
            body: data,
            headers: {
                /*'Content-Type': "multipart/form-data",*/
                'Authorization': 'Bearer ' + token
                // You may need to include additional headers like Authorization token if required by your backend
            }
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401)
                    {
                         location.href = 'registration.html'
                    }
                    throw new Error('Failed to fetch user profile');
                }
                return response.json();
            })
            .then(data => {

            })
            .catch(error => {
                console.error('Error fetching user profile:', error);
            })
        // Make API call to upload profile picture
    }

    function changePassword() {
        const token = localStorage.getItem("jwtToken")
        let oldPassword = document.getElementById('oldPasswordInput').value;
        let newPassword = document.getElementById('newPasswordInput').value;

        let passwordData = {oldPassword, newPassword}
        fetch('http://localhost:8080/users/changePassword', {
            method: 'POST',
            body: JSON.stringify(passwordData),
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
                // You may need to include additional headers like Authorization token if required by your backend
            }
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401)
                    {
                        location.href = 'registration.html'
                    }
                    throw new Error('Failed to fetch user profile');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById("successMessage").style.display = "block"

                setTimeout(() => {
                    document.getElementById("successMessage").style.display = "none"
                    document.getElementById("closeChangePasswordModal").click()
                }, 2000)
            })
            .catch(error => {
                console.error('Error fetching user profile:', error);
            })
        .finally(() =>{
            document.getElementById("successMessage").style.display = "block"

            setTimeout(() => {
                document.getElementById("successMessage").style.display = "none"
                document.getElementById("closeChangePasswordModal").click()
            }, 2000)
        });
        // Make API call to change password
    }

    async function deleteAccount() {
        // Implement logic to delete account using your API endpoint
        const token = localStorage.getItem("jwtToken")

        try
        {
            const response = await fetch("http://localhost:8080/users/deleteAccount", {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                    // You may need to include additional headers like Authorization token if required by your backend
                }
            });
            document.getElementById("closeChangePasswordModal1").click()

        }
        catch (error){
        console.log(error)
        }

        // Make API call to delete account
    }
    function changePhoneNumber() {
        let newPhoneNumber = document.getElementById('newPhoneNumber').value;
        const token = localStorage.getItem("jwtToken");

        fetch('http://localhost:8080/users/setPhoneNumber', {
            method: 'POST',
            body: JSON.stringify(newPhoneNumber),
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to change phone number');
                }
                return response.json();
            })
            .then(data => {
                // Update UI to reflect the changed phone number
                document.getElementById('phoneNumber').innerText = data.phoneNumber;
                // Optionally, provide feedback to the user that the phone number has been updated
                alert('Phone number updated successfully');
            })
            .catch(error => {
                console.error('Error changing phone number:', error);
                // Optionally, provide feedback to the user that an error occurred
              //  alert('Failed to change phone number. Please try again later.');
            });
    }

    function changeAddress() {

        let country = document.getElementById('country').value;
        let city = document.getElementById('city').value;
        let street = document.getElementById('street').value;
        let building = document.getElementById('building').value;
        let postalCode = document.getElementById('postalCode').value;

        // console.log(country)
        const token = localStorage.getItem("jwtToken");

        let addressData = { country, city, street, building, postalCode };

        fetch('http://localhost:8080/users/setAddress', {
            method: 'PATCH',
            body: JSON.stringify(addressData),
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to change address');
                }
                return response.json();
            })
            .then(data => {
                // Update UI to reflect the changed address
                document.getElementById('address').innerText = data.address;
                // Optionally, provide feedback to the user that the address has been updated
                alert('Address updated successfully');
            })
            .catch(error => {
                console.error('Error changing address:', error);
                // Optionally, provide feedback to the user that an error occurred
              //  alert('Failed to change address. Please try again later.');
            });

    }

    // Load user profile when the page loads
    window.onload = function() {
        getUserProfile();
    };

</script>
</body>
</html>
